/**
 * PANEL SRI ECUADOR - INTERFAZ PROFESIONAL CON IA
 * Sistema inteligente de gesti√≥n tributaria ecuatoriana
 */

(function() {
  const TEMPLATE = /* html */`
    <div class="sri-panel-pro">
      <!-- HEADER CON ESTADO Y ACCIONES R√ÅPIDAS -->
      <header class="sri-header">
        <div class="sri-header-content">
          <div class="sri-title-section">
            <div class="sri-icon-badge">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div>
              <h1>Sistema SRI Ecuador</h1>
              <p class="sri-subtitle">Gesti√≥n tributaria inteligente con asistencia IA</p>
            </div>
          </div>
          
          <div class="sri-quick-actions">
            <button class="btn-action btn-portal" id="btn-portal-sri-header" title="Ir al portal de declaraciones del SRI">
              <i class="fas fa-external-link-alt"></i>
              <span>Portal SRI</span>
            </button>
            <button class="btn-action btn-ia" id="btn-asistente-ia-header">
              <i class="fas fa-robot"></i>
              <span>Asistente IA</span>
            </button>
            <button class="btn-action btn-config" id="btn-config-header">
              <i class="fas fa-cog"></i>
              <span>Configurar</span>
            </button>
          </div>
        </div>

        <!-- ALERTAS Y ESTADO -->
        <div class="sri-alerts" id="sri-alerts-container">
        </div>
      </header>

      <!-- DASHBOARD PRINCIPAL CON CARDS VISUALES -->
      <div class="sri-dashboard">
        
        <!-- SECCI√ìN: DECLARACIONES MENSUALES CON IA -->
        <section class="sri-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="section-title">
              <h2>Declaraciones Mensuales</h2>
              <p>La IA te gu√≠a paso a paso en cada formulario</p>
            </div>
          </div>

          <div class="cards-grid">
            <!-- FORMULARIO 103 -->
            <div class="sri-card card-form103">
              <div class="card-header-mini">
                <div class="card-badge badge-monthly">MENSUAL</div>
                <div class="card-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
              </div>
              <div class="card-content">
                <h3>Formulario 103</h3>
                <p class="card-desc">Retenciones en la Fuente del IR</p>
                <div class="card-stats">
                  <div class="stat-item">
                    <i class="fas fa-calendar"></i>
                    <span class="stat-label">Plazo:</span>
                    <span class="stat-value" id="plazo-103">Calculando...</span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="stat-label">√öltima declaraci√≥n:</span>
                    <span class="stat-value" id="ultimo-103">N/A</span>
                  </div>
                </div>
              </div>
              <div class="card-actions">
                <button class="btn-primary-card" onclick="SRIPanel.iniciarWorkflow103()">
                  <i class="fas fa-magic"></i> Generar con IA
                </button>
                <button class="btn-secondary-card" onclick="SRIPanel.verHistorial('103')">
                  <i class="fas fa-history"></i> Historial
                </button>
              </div>
            </div>

            <!-- FORMULARIO 104 -->
            <div class="sri-card card-form104">
              <div class="card-header-mini">
                <div class="card-badge badge-monthly">MENSUAL</div>
                <div class="card-icon">
                  <i class="fas fa-percent"></i>
                </div>
              </div>
              <div class="card-content">
                <h3>Formulario 104</h3>
                <p class="card-desc">IVA - Impuesto al Valor Agregado</p>
                <div class="card-stats">
                  <div class="stat-item">
                    <i class="fas fa-calendar"></i>
                    <span class="stat-label">Plazo:</span>
                    <span class="stat-value" id="plazo-104">Calculando...</span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="stat-label">IVA a pagar:</span>
                    <span class="stat-value" id="iva-pagar">N/A</span>
                  </div>
                </div>
              </div>
              <div class="card-actions">
                <button class="btn-primary-card" onclick="SRIPanel.iniciarWorkflow104()">
                  <i class="fas fa-magic"></i> Generar con IA
                </button>
                <button class="btn-secondary-card" onclick="SRIPanel.verHistorial('104')">
                  <i class="fas fa-history"></i> Historial
                </button>
              </div>
            </div>

            <!-- ANEXO ATS -->
            <div class="sri-card card-ats">
              <div class="card-header-mini">
                <div class="card-badge badge-monthly">MENSUAL</div>
                <div class="card-icon">
                  <i class="fas fa-file-code"></i>
                </div>
              </div>
              <div class="card-content">
                <h3>Anexo ATS</h3>
                <p class="card-desc">Anexo Transaccional Simplificado</p>
                <div class="card-stats">
                  <div class="stat-item">
                    <i class="fas fa-file-export"></i>
                    <span class="stat-label">√öltimo generado:</span>
                    <span class="stat-value" id="ultimo-ats">N/A</span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-receipt"></i>
                    <span class="stat-label">Transacciones:</span>
                    <span class="stat-value" id="total-transacciones">0</span>
                  </div>
                </div>
              </div>
              <div class="card-actions">
                <button class="btn-primary-card" onclick="SRIPanel.generarATSAutomatico()">
                  <i class="fas fa-download"></i> Generar XML
                </button>
                <button class="btn-secondary-card" onclick="SRIPanel.verHistorialATS()">
                  <i class="fas fa-list"></i> Ver archivos
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- SECCI√ìN: DOCUMENTOS ELECTR√ìNICOS -->
        <section class="sri-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <div class="section-title">
              <h2>Documentos Electr√≥nicos</h2>
              <p>Emite y gestiona comprobantes autorizados por el SRI</p>
            </div>
          </div>

          <div class="docs-grid">
            <div class="doc-quick-card" onclick="SRIPanel.abrirDocumento('facturas')">
              <div class="doc-icon facturas-icon">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              <div class="doc-info">
                <h4>Facturas</h4>
                <p class="doc-count" id="count-facturas">0 este mes</p>
              </div>
              <i class="fas fa-arrow-right doc-arrow"></i>
            </div>

            <div class="doc-quick-card" onclick="SRIPanel.abrirDocumento('retenciones')">
              <div class="doc-icon retenciones-icon">
                <i class="fas fa-receipt"></i>
              </div>
              <div class="doc-info">
                <h4>Retenciones</h4>
                <p class="doc-count" id="count-retenciones">0 este mes</p>
              </div>
              <i class="fas fa-arrow-right doc-arrow"></i>
            </div>

            <div class="doc-quick-card" onclick="SRIPanel.abrirDocumento('notas-credito')">
              <div class="doc-icon nc-icon">
                <i class="fas fa-file-export"></i>
              </div>
              <div class="doc-info">
                <h4>Notas Cr√©dito</h4>
                <p class="doc-count" id="count-nc">0 este mes</p>
              </div>
              <i class="fas fa-arrow-right doc-arrow"></i>
            </div>

            <div class="doc-quick-card" onclick="SRIPanel.abrirDocumento('guias-remision')">
              <div class="doc-icon guias-icon">
                <i class="fas fa-truck"></i>
              </div>
              <div class="doc-info">
                <h4>Gu√≠as Remisi√≥n</h4>
                <p class="doc-count" id="count-guias">0 este mes</p>
              </div>
              <i class="fas fa-arrow-right doc-arrow"></i>
            </div>
          </div>
        </section>

        <!-- SECCI√ìN: ANALIZADORES EST√ÅTICOS -->
        <section class="sri-section sri-section-lint">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-shield-alt"></i>
            </div>
            <div class="section-title">
              <h2>Analizadores est√°ticos</h2>
              <p>Linters y verificadores antes de declarar</p>
            </div>
          </div>

          <div class="lint-header">
            <div>
              <h3>Diagn√≥stico en tiempo real</h3>
              <p id="lint-last-run">Sin ejecutar</p>
            </div>
            <button class="btn-lint-refresh" onclick="SRIPanel.ejecutarDiagnostico()">
              <i class="fas fa-sync-alt"></i>
              <span>Reanalizar</span>
            </button>
          </div>

          <div class="lint-metrics">
            <div class="lint-score-card">
              <span class="lint-score-value" id="lint-score-value">--</span>
              <span class="lint-score-label">Salud tributaria</span>
            </div>
            <div class="lint-metric">
              <span class="lint-metric-label">Cr√≠ticos</span>
              <span class="lint-metric-value critical" id="lint-critical-count">0</span>
            </div>
            <div class="lint-metric">
              <span class="lint-metric-label">Advertencias</span>
              <span class="lint-metric-value warning" id="lint-warning-count">0</span>
            </div>
            <div class="lint-metric">
              <span class="lint-metric-label">Notas</span>
              <span class="lint-metric-value info" id="lint-info-count">0</span>
            </div>
            <div class="lint-metric">
              <span class="lint-metric-label">Cobertura</span>
              <span class="lint-metric-value" id="lint-coverage">0%</span>
            </div>
          </div>

          <div class="lint-issues" id="lint-issues-list">
            <div class="lint-placeholder">Ejecuta el analizador para ver recomendaciones.</div>
          </div>
        </section>

        <!-- SECCI√ìN: ASISTENTE IA -->
        <section class="sri-section sri-section-ia">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="section-title">
              <h2>Asistente IA Contable</h2>
              <p>Tu experto tributario disponible 24/7</p>
            </div>
          </div>

          <div class="ia-capabilities">
            <div class="ia-feature">
              <i class="fas fa-lightbulb"></i>
              <h4>Responde consultas</h4>
              <p>Normativa SRI, c√≥digos, plazos</p>
            </div>
            <div class="ia-feature">
              <i class="fas fa-calculator"></i>
              <h4>Calcula impuestos</h4>
              <p>Retenciones, IVA, proyecciones</p>
            </div>
            <div class="ia-feature">
              <i class="fas fa-tasks"></i>
              <h4>Gu√≠a paso a paso</h4>
              <p>Declaraciones y formularios</p>
            </div>
            <div class="ia-feature">
              <i class="fas fa-chart-line"></i>
              <h4>Analiza datos</h4>
              <p>Encuentra errores y oportunidades</p>
            </div>
          </div>

          <div class="ia-cta">
            <button class="btn-ia-large" onclick="SRIPanel.abrirAsistenteIA()">
              <i class="fas fa-comments"></i> Iniciar conversaci√≥n con la IA
            </button>
          </div>
        </section>
      </div>
    </div>
  `;

  const STYLES = /* css */`
    .sri-panel-pro {
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    [data-theme="dark"] .sri-panel-pro {
      background: linear-gradient(135deg, #4338ca 0%, #581c87 100%);
    }

    .sri-header {
      background: white;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 30px;
    }

    [data-theme="dark"] .sri-header {
      background: #1f2937;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .sri-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .sri-title-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .sri-icon-badge {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .sri-title-section h1 {
      margin: 0;
      font-size: 28px;
      color: #1f2937;
      font-weight: 700;
    }

    [data-theme="dark"] .sri-title-section h1 {
      color: #f9fafb;
    }

    .sri-subtitle {
      margin: 5px 0 0 0;
      color: #6b7280;
      font-size: 15px;
    }

    [data-theme="dark"] .sri-subtitle {
      color: #9ca3af;
    }

    .sri-quick-actions {
      display: flex;
      gap: 12px;
    }

    .btn-action {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-action i {
      font-size: 18px;
    }

    .btn-action.btn-ia {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-action.btn-ia:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-action.btn-config {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-action.btn-config:hover {
      background: #667eea;
      color: white;
    }

    .btn-action.btn-portal {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-action.btn-portal:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .sri-dashboard {
      padding: 0 30px 30px 30px;
    }

    .sri-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    [data-theme="dark"] .sri-section {
      background: #1f2937;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .section-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .section-title h2 {
      margin: 0;
      font-size: 22px;
      color: #1f2937;
      font-weight: 700;
    }

    [data-theme="dark"] .section-title h2 {
      color: #f9fafb;
    }

    .section-title p {
      margin: 4px 0 0 0;
      color: #6b7280;
      font-size: 14px;
    }

    [data-theme="dark"] .section-title p {
      color: #9ca3af;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .sri-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .sri-card {
      background: #111827;
      border-color: #374151;
    }

    .sri-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      border-color: #667eea;
    }

    [data-theme="dark"] .sri-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border-color: #818cf8;
    }

    .card-header-mini {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-badge {
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-monthly {
      background: #fef3c7;
      color: #92400e;
    }

    .card-icon {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .card-content h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #1f2937;
      font-weight: 700;
    }

    [data-theme="dark"] .card-content h3 {
      color: #f9fafb;
    }

    .card-desc {
      margin: 0 0 15px 0;
      color: #6b7280;
      font-size: 14px;
    }

    [data-theme="dark"] .card-desc {
      color: #9ca3af;
    }

    .card-stats {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    .stat-item i {
      color: #667eea;
      width: 16px;
    }

    .stat-label {
      font-weight: 600;
    }

    .stat-value {
      color: #1f2937;
      font-weight: 700;
    }

    [data-theme="dark"] .stat-value {
      color: #f3f4f6;
    }

    [data-theme="dark"] .stat-item {
      color: #9ca3af;
    }

    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-primary-card {
      flex: 1;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-primary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary-card {
      padding: 12px 20px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .btn-secondary-card {
      background: #111827;
      color: #818cf8;
      border-color: #818cf8;
    }

    .btn-secondary-card:hover {
      background: #f3f4f6;
    }

    [data-theme="dark"] .btn-secondary-card:hover {
      background: #1f2937;
    }

    .docs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .doc-quick-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .doc-quick-card {
      background: #111827;
      border-color: #374151;
    }

    .doc-quick-card:hover {
      background: white;
      border-color: #667eea;
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    [data-theme="dark"] .doc-quick-card:hover {
      background: #1f2937;
      border-color: #818cf8;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .doc-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .facturas-icon {
      background: #dbeafe;
      color: #1e40af;
    }

    .retenciones-icon {
      background: #fef3c7;
      color: #92400e;
    }

    .nc-icon {
      background: #f3e8ff;
      color: #6b21a8;
    }

    .guias-icon {
      background: #d1fae5;
      color: #065f46;
    }

    .doc-info h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: #1f2937;
      font-weight: 700;
    }

    [data-theme="dark"] .doc-info h4 {
      color: #f9fafb;
    }

    .doc-count {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    [data-theme="dark"] .doc-count {
      color: #9ca3af;
    }

    .doc-arrow {
      margin-left: auto;
      color: #9ca3af;
      font-size: 18px;
      transition: transform 0.3s ease;
    }

    .doc-quick-card:hover .doc-arrow {
      transform: translateX(5px);
      color: #667eea;
    }

    [data-theme="dark"] .doc-quick-card:hover .doc-arrow {
      color: #818cf8;
    }

    .sri-section-lint {
      background: linear-gradient(135deg, #0f172a 0%, #1f2937 100%);
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    [data-theme="dark"] .sri-section-lint {
      background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
      border-color: rgba(99, 102, 241, 0.4);
    }

    .sri-section-lint .section-icon {
      background: rgba(99, 102, 241, 0.35);
    }

    .sri-section-lint .section-title h2,
    .sri-section-lint .section-title p {
      color: #e2e8f0;
    }

    .lint-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .lint-header h3 {
      margin: 0;
      font-size: 18px;
      color: #f8fafc;
    }

    .lint-header p {
      margin: 4px 0 0 0;
      color: #94a3b8;
      font-size: 13px;
    }

    .btn-lint-refresh {
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(99, 102, 241, 0.2);
      color: #f8fafc;
      font-weight: 600;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-lint-refresh:hover {
      background: rgba(99, 102, 241, 0.35);
      transform: translateY(-1px);
    }

    .btn-lint-refresh.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .lint-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .lint-score-card {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      text-align: center;
    }

    .lint-score-value {
      font-size: 34px;
      font-weight: 700;
      display: block;
      color: #38bdf8;
    }

    .lint-score-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .lint-metric {
      background: rgba(15, 23, 42, 0.4);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .lint-metric-label {
      font-size: 13px;
      color: #cbd5f5;
    }

    .lint-metric-value {
      font-size: 22px;
      font-weight: 700;
      color: #f8fafc;
    }

    .lint-metric-value.critical {
      color: #f87171;
    }

    .lint-metric-value.warning {
      color: #fbbf24;
    }

    .lint-metric-value.info {
      color: #38bdf8;
    }

    .lint-issues {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lint-issue {
      background: rgba(15, 23, 42, 0.75);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-left: 4px solid #38bdf8;
    }

    .lint-issue[data-severity="critical"] {
      border-left-color: #f87171;
    }

    .lint-issue[data-severity="warning"] {
      border-left-color: #fbbf24;
    }

    .lint-issue-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .lint-issue-head h4 {
      margin: 4px 0 0 0;
      font-size: 16px;
      color: #f8fafc;
    }

    .lint-severity {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .lint-critical {
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
    }

    .lint-warning {
      background: rgba(251, 191, 36, 0.15);
      color: #fde68a;
    }

    .lint-info {
      background: rgba(56, 189, 248, 0.15);
      color: #bae6fd;
    }

    .lint-message {
      margin: 0;
      color: #cbd5f5;
      font-size: 14px;
    }

    .lint-affected {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .lint-chip {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .lint-hint {
      margin: 10px 0 0 0;
      font-size: 13px;
      color: #cbd5f5;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .lint-placeholder,
    .lint-empty,
    .lint-error {
      text-align: center;
      padding: 25px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      color: #cbd5f5;
      font-size: 14px;
    }

    .lint-error {
      border-color: rgba(248, 113, 113, 0.5);
      color: #fecaca;
    }

    .lint-rule {
      font-size: 11px;
      color: #94a3b8;
      font-family: 'Fira Code', 'Roboto Mono', monospace;
    }

    @media (max-width: 768px) {
      .lint-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .sri-section-ia {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    [data-theme="dark"] .sri-section-ia {
      background: linear-gradient(135deg, #4338ca 0%, #581c87 100%);
    }

    .sri-section-ia .section-icon {
      background: rgba(255,255,255,0.2);
    }

    .sri-section-ia .section-title h2,
    .sri-section-ia .section-title p {
      color: white;
    }

    .ia-capabilities {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .ia-feature {
      text-align: center;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .ia-feature i {
      font-size: 32px;
      margin-bottom: 10px;
      display: block;
      color: white;
    }

    .ia-feature h4 {
      margin: 0 0 6px 0;
      font-size: 16px;
      font-weight: 700;
    }

    .ia-feature p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .ia-cta {
      text-align: center;
    }

    .btn-ia-large {
      padding: 18px 40px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .btn-ia-large:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
    }

    @media (max-width: 768px) {
      .sri-header {
        padding: 20px;
      }

      .sri-header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .sri-title-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .sri-dashboard {
        padding: 0 15px 15px 15px;
      }

      .sri-section {
        padding: 20px;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .docs-grid {
        grid-template-columns: 1fr;
      }

      .ia-capabilities {
        grid-template-columns: 1fr 1fr;
      }
    }
  `;

  let lintState = {
    loading: false,
    result: null
  };

  // ============================================
  // L√ìGICA DEL PANEL
  // ============================================

  function initialize() {
    injectStyles();
    
    // Diagn√≥stico inmediato al cargar
    console.log('üîç =================================');
    console.log('üîç DIAGN√ìSTICO SISTEMA SRI ECUADOR');
    console.log('üîç =================================');
    
    // 1. Verificar dependencias cr√≠ticas
    const dependencies = {
      Database: typeof window.Database !== 'undefined',
      IAUnifiedEngine: typeof window.IAUnifiedEngine !== 'undefined',
      SRIAsistenteIA: typeof window.SRIAsistenteIA !== 'undefined',
      Auth: typeof window.Auth !== 'undefined',
      Utils: typeof window.Utils !== 'undefined'
    };
    
    console.log('üì¶ Dependencias:', dependencies);
    
    // 2. Verificar estado de IA espec√≠ficamente
    if (dependencies.IAUnifiedEngine) {
      const iaStatus = IAUnifiedEngine.getStatus ? IAUnifiedEngine.getStatus() : null;
      console.log('ü§ñ Estado IA:', iaStatus);
      
      if (!iaStatus) {
        console.error('‚ùå IAUnifiedEngine.getStatus() no funciona');
      } else {
        if (!iaStatus.initialized) {
          console.warn('‚ö†Ô∏è IAUnifiedEngine no est√° inicializado');
        }
        if (!iaStatus.serverConfigured) {
          console.error('‚ùå IA no configurada en el servidor');
          console.log('üí° Soluci√≥n: Ve a Dashboard ‚Üí Configuraci√≥n ‚Üí Inteligencia Artificial');
        }
        if (iaStatus.serverConfigured && !iaStatus.hasApiKey) {
          console.error('‚ùå API Key no configurada');
          console.log('üí° Soluci√≥n: Ingresa tu API Key en la configuraci√≥n de IA');
        }
        if (iaStatus.serverConfigured && iaStatus.hasApiKey) {
          console.log('‚úÖ IA configurada correctamente:', iaStatus.providerName || iaStatus.provider);
        }
      }
    } else {
      console.error('‚ùå IAUnifiedEngine no disponible');
      console.log('üí° Soluci√≥n: Verifica que ia-unified-engine.js est√© cargado');
    }
    
    // 3. Verificar asistente SRI
    if (dependencies.SRIAsistenteIA) {
      if (window.SRIAsistenteIA.config) {
        console.log('üéØ Asistente SRI:', {
          enabled: window.SRIAsistenteIA.config.enabled,
          provider: window.SRIAsistenteIA.config.provider,
          model: window.SRIAsistenteIA.config.model
        });
      }
    } else {
      console.warn('‚ö†Ô∏è SRIAsistenteIA no disponible');
    }
    
    console.log('üîç =================================\n');
    
    // Continuar con la inicializaci√≥n normal
    loadDashboardData();
    setupEventListeners();
    checkAlerts();
    renderDiagnostics();
  }

  function injectStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = STYLES;
    document.head.appendChild(styleElement);
  }

  function setupEventListeners() {
    const btnPortal = document.getElementById('btn-portal-sri-header');
    const btnIA = document.getElementById('btn-asistente-ia-header');
    const btnConfig = document.getElementById('btn-config-header');

    if (btnPortal) {
      btnPortal.addEventListener('click', () => {
        window.open('https://declaraciones.sri.gob.ec/tuportal-internet/', '_blank', 'noopener,noreferrer');
        showToast('üåê Abriendo portal de declaraciones del SRI...', 'success');
      });
    }

    if (btnIA) {
      btnIA.addEventListener('click', () => abrirAsistenteIA());
    }

    if (btnConfig) {
      btnConfig.addEventListener('click', () => abrirConfiguracion());
    }
  }

  async function loadDashboardData() {
    await Promise.all([
      calcularPlazos(),
      cargarEstadisticasDocumentos(),
      cargarUltimasDeclaraciones()
    ]);
  }

  function calcularPlazos() {
    const now = new Date();
    const ruc = obtenerRUC();
    const novenoDigito = ruc ? ruc.charAt(8) : '0';
    
    const fechasLimite = {
      '1': 10, '2': 12, '3': 14, '4': 16, '5': 18,
      '6': 20, '7': 22, '8': 24, '9': 26, '0': 28
    };

    const diaLimite = fechasLimite[novenoDigito] || 28;
    const mesActual = now.getMonth() + 1;
    const anioActual = now.getFullYear();
    
    const fechaLimite = new Date(anioActual, mesActual, diaLimite);
    const diasRestantes = Math.ceil((fechaLimite - now) / (1000 * 60 * 60 * 24));

    const textoFecha = `${diaLimite}/${mesActual.toString().padStart(2,'0')} (${diasRestantes > 0 ? diasRestantes + ' d√≠as' : 'Vencido'})`;

    const elem103 = document.getElementById('plazo-103');
    const elem104 = document.getElementById('plazo-104');

    if (elem103) elem103.textContent = textoFecha;
    if (elem104) elem104.textContent = textoFecha;
  }

  function cargarEstadisticasDocumentos() {
    if (typeof Database === 'undefined') return;

    const now = new Date();
    const mesActual = now.getMonth() + 1;
    const anioActual = now.getFullYear();

    const facturas = Database.getCollection('facturas') || [];
    const retenciones = Database.getCollection('retenciones') || [];
    const notasCredito = Database.getCollection('notasCredito') || [];
    const guias = Database.getCollection('guiasRemision') || [];

    const filtrarMes = (items) => {
      return items.filter(item => {
        const fecha = new Date(item.fecha || item.createdAt);
        return fecha.getMonth() + 1 === mesActual && fecha.getFullYear() === anioActual;
      });
    };

    const countFacturas = filtrarMes(facturas).length;
    const countRetenciones = filtrarMes(retenciones).length;
    const countNC = filtrarMes(notasCredito).length;
    const countGuias = filtrarMes(guias).length;

    const elemFacturas = document.getElementById('count-facturas');
    const elemRetenciones = document.getElementById('count-retenciones');
    const elemNC = document.getElementById('count-nc');
    const elemGuias = document.getElementById('count-guias');

    if (elemFacturas) elemFacturas.textContent = `${countFacturas} este mes`;
    if (elemRetenciones) elemRetenciones.textContent = `${countRetenciones} este mes`;
    if (elemNC) elemNC.textContent = `${countNC} este mes`;
    if (elemGuias) elemGuias.textContent = `${countGuias} este mes`;

    const elemTransacciones = document.getElementById('total-transacciones');
    if (elemTransacciones) {
      elemTransacciones.textContent = countFacturas + countRetenciones + countNC;
    }
  }

  function cargarUltimasDeclaraciones() {
    // Placeholder para futuras declaraciones guardadas
    const elem103 = document.getElementById('ultimo-103');
    const elemIVA = document.getElementById('iva-pagar');
    const elemATS = document.getElementById('ultimo-ats');

    if (elem103) elem103.textContent = 'No declarado';
    if (elemIVA) elemIVA.textContent = '$0.00';
    if (elemATS) elemATS.textContent = 'Nunca generado';
  }

  function checkAlerts() {
    const container = document.getElementById('sri-alerts-container');
    if (!container) return;

    const alerts = [];

    // PRIORIDAD 1: Verificar IA
    if (typeof window.IAUnifiedEngine === 'undefined') {
      alerts.push({
        type: 'error',
        icon: 'fa-robot',
        title: 'Motor de IA no disponible',
        message: 'El asistente tributario no puede funcionar. Verifica que ia-unified-engine.js est√© cargado.',
        action: null
      });
    } else {
      const iaStatus = IAUnifiedEngine.getStatus ? IAUnifiedEngine.getStatus() : null;
      
      if (iaStatus) {
        if (!iaStatus.initialized) {
          alerts.push({
            type: 'warning',
            icon: 'fa-hourglass-half',
            title: 'IA inicializando...',
            message: 'Espera unos segundos o recarga la p√°gina.',
            action: null
          });
        } else if (!iaStatus.serverConfigured) {
          alerts.push({
            type: 'error',
            icon: 'fa-cog',
            title: 'IA no configurada',
            message: 'El asistente requiere configuraci√≥n. Ve a Dashboard ‚Üí Configuraci√≥n ‚Üí Inteligencia Artificial',
            action: { text: 'Configurar ahora', handler: 'abrirConfiguracion' }
          });
        } else if (!iaStatus.hasApiKey) {
          alerts.push({
            type: 'error',
            icon: 'fa-key',
            title: 'API Key faltante',
            message: `Proveedor ${iaStatus.providerName || iaStatus.provider} sin API Key. Ingresa tu clave en la configuraci√≥n.`,
            action: { text: 'Configurar', handler: 'abrirConfiguracion' }
          });
        } else {
          // IA OK
          alerts.push({
            type: 'success',
            icon: 'fa-check-circle',
            title: '‚úÖ Asistente IA activo',
            message: `${iaStatus.providerName || iaStatus.provider} | ${iaStatus.model || 'Modelo por defecto'}`,
            action: { text: 'Abrir chat', handler: 'abrirAsistenteIA' }
          });
        }
      }
    }

    // PRIORIDAD 2: Verificar RUC
    const ruc = obtenerRUC();
    if (!ruc || ruc.length !== 13) {
      alerts.push({
        type: 'warning',
        icon: 'fa-exclamation-triangle',
        title: 'Configuraci√≥n SRI incompleta',
        message: 'Debes configurar tu RUC en Dashboard ‚Üí Configuraci√≥n ‚Üí Tab SRI',
        action: { text: 'Configurar', handler: 'abrirConfiguracion' }
      });
    }

    // Renderizar alertas
    if (alerts.length === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = alerts.map(alert => `
      <div class="alert alert-${alert.type}" style="margin-top: 15px; display: flex; align-items: center; gap: 12px; padding: 12px; background: ${getAlertBg(alert.type)}; border-left: 4px solid ${getAlertColor(alert.type)}; border-radius: 8px;">
        <i class="fas ${alert.icon}" style="color: ${getAlertColor(alert.type)}; font-size: 20px;"></i>
        <div style="flex: 1;">
          <strong style="color: ${getAlertTextColor(alert.type)};">${alert.title}</strong>
          <p style="margin: 4px 0 0 0; color: ${getAlertTextColor(alert.type)}; font-size: 14px;">${alert.message}</p>
        </div>
        ${alert.action ? `
          <button class="btn btn-sm btn-primary" onclick="SRIPanel.${alert.action.handler}()" style="white-space: nowrap;">
            ${alert.action.text}
          </button>
        ` : ''}
      </div>
    `).join('');
  }

  function getAlertBg(type) {
    const colors = {
      error: '#fef2f2',
      warning: '#fef3c7',
      success: '#d1fae5',
      info: '#dbeafe'
    };
    return colors[type] || colors.info;
  }

  function getAlertColor(type) {
    const colors = {
      error: '#dc2626',
      warning: '#f59e0b',
      success: '#059669',
      info: '#3b82f6'
    };
    return colors[type] || colors.info;
  }

  function getAlertTextColor(type) {
    const colors = {
      error: '#991b1b',
      warning: '#92400e',
      success: '#065f46',
      info: '#1e40af'
    };
    return colors[type] || colors.info;
  }

  function obtenerRUC() {
    if (typeof Database === 'undefined') return '';
    const config = Database.get('configuracionAvanzada') || {};
    return config.sri?.ruc || '';
  }

  // ============================================
  // WORKFLOWS CON IA
  // ============================================

  function iniciarWorkflow103() {
    if (typeof SRIFormularios === 'undefined' || typeof SRIFormularios.generarBorrador !== 'function') {
      showToast('M√≥dulo de formularios no disponible. Recarga la p√°gina.', 'error');
      return;
    }
    
    showToast('ü§ñ Preparando Formulario 103 con tus datos...', 'info');
    SRIFormularios.generarBorrador('103');
  }

  function iniciarWorkflow104() {
    if (typeof SRIFormularios === 'undefined' || typeof SRIFormularios.generarBorrador !== 'function') {
      showToast('M√≥dulo de formularios no disponible. Recarga la p√°gina.', 'error');
      return;
    }
    
    showToast('ü§ñ Preparando Formulario 104 (IVA) con tus datos...', 'info');
    SRIFormularios.generarBorrador('104');
  }

  function generarATSAutomatico() {
    if (typeof SRIFormularios === 'undefined' || typeof SRIFormularios.generarAutomatico !== 'function') {
      showToast('M√≥dulo de formularios no disponible. Recarga la p√°gina.', 'error');
      return;
    }
    
    showToast('üì¶ Generando ATS (Anexo Transaccional) autom√°ticamente...', 'info');
    SRIFormularios.generarAutomatico('ATS');
  }

  function verHistorial(formulario) {
    const urls = {
      '103': 'https://declaraciones.sri.gob.ec/tuportal-internet/',
      '104': 'https://declaraciones.sri.gob.ec/tuportal-internet/'
    };
    
    const url = urls[formulario];
    if (url) {
      showToast(`üìä Abriendo portal SRI para consultar Formulario ${formulario}...`, 'info');
      setTimeout(() => {
        window.open(url, '_blank', 'noopener,noreferrer');
      }, 500);
    } else {
      showToast(`Historial de Formulario ${formulario} - Pr√≥ximamente`, 'info');
    }
  }

  function verHistorialATS() {
    if (typeof SRITributacionService !== 'undefined' && typeof SRITributacionService.obtenerHistorialATS === 'function') {
      const historial = SRITributacionService.obtenerHistorialATS();
      
      if (!historial || !historial.length) {
        showToast('No has generado ning√∫n ATS todav√≠a', 'info');
        return;
      }

      const contenido = `
        <div style="max-height: 400px; overflow-y: auto;">
          ${historial.slice(0, 10).map(item => `
            <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #1f2937;">Per√≠odo: ${item.month || 'N/A'}/${item.year || 'N/A'}</strong>
                <span style="font-size: 12px; color: #6b7280;">${new Date(item.timestamp).toLocaleDateString()}</span>
              </div>
              <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
                <i class="fas fa-file-code"></i> ${item.nombreArchivo || 'Sin nombre'}
              </p>
              <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 13px; color: #6b7280;">
                <span><i class="fas fa-shopping-cart"></i> Ventas: ${item.resumen?.totalVentas || 0}</span>
                <span><i class="fas fa-truck"></i> Compras: ${item.resumen?.totalCompras || 0}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      if (typeof Utils !== 'undefined' && typeof Utils.createModal === 'function') {
        const modal = Utils.createModal({
          title: 'üìä Historial de ATS Generados',
          size: 'medium',
          content: contenido
        });
        if (modal?.show) modal.show();
      }
    } else {
      showToast('No hay historial de ATS disponible', 'info');
    }
  }

  function abrirDocumento(tipo) {
    if (typeof Ventas !== 'undefined' && typeof Ventas.cambiarSeccion === 'function') {
      Ventas.cambiarSeccion('facturacion');
      
      setTimeout(() => {
        const tabBtn = document.querySelector(`[data-tab="${tipo}"]`);
        if (tabBtn) tabBtn.click();
      }, 150);
    } else {
      showToast('M√≥dulo de facturaci√≥n no disponible', 'error');
    }
  }

  function abrirAsistenteIA() {
    if (typeof SRIAsistenteIA !== 'undefined' && typeof SRIAsistenteIA.abrirChat === 'function') {
      SRIAsistenteIA.abrirChat();
    } else {
      showToast('Asistente IA no disponible. Verifica la configuraci√≥n.', 'warning');
    }
  }

  function abrirConfiguracion() {
    if (typeof App !== 'undefined' && typeof App.loadModule === 'function') {
      App.loadModule('configuracion');
    } else {
      showToast('Ir a: Dashboard ‚Üí Configuraci√≥n ‚Üí Tab SRI', 'info');
    }
  }

  function showToast(mensaje, tipo = 'success') {
    if (typeof Utils !== 'undefined' && typeof Utils.showToast === 'function') {
      Utils.showToast(mensaje, tipo);
    } else {
      console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
    }
  }

  function renderDiagnostics(showFeedback = false) {
    const list = document.getElementById('lint-issues-list');
    const lastRun = document.getElementById('lint-last-run');
    if (!list || !lastRun) return;

    if (!window.SRILintEngine || typeof SRILintEngine.analyze !== 'function') {
      list.innerHTML = '<div class="lint-error">Instala <code>js/sri-diagnostics.js</code> para habilitar los linters.</div>';
      lastRun.textContent = 'Motor no disponible';
      return;
    }

    if (lintState.loading) return;

    lintState.loading = true;
    setLintLoading(true);
    list.innerHTML = '<div class="lint-placeholder">Analizando datos tributarios...</div>';
    lastRun.textContent = 'Ejecutando an√°lisis...';

    requestAnimationFrame(() => {
      const result = SRILintEngine.analyze();
      lintState.result = result;
      updateLintMetrics(result.stats);
      lastRun.textContent = `√öltima ejecuci√≥n: ${formatTimestamp(result.timestamp)}`;
      list.innerHTML = renderIssueList(result.issues);
      if (showFeedback) {
        showToast('Diagn√≥stico SRI actualizado', 'success');
      }
      lintState.loading = false;
      setLintLoading(false);
    });
  }

  function updateLintMetrics(stats = {}) {
    setText('lint-score-value', typeof stats.score === 'number' ? stats.score : '--');
    setText('lint-critical-count', stats.critical ?? 0);
    setText('lint-warning-count', stats.warning ?? 0);
    setText('lint-info-count', stats.info ?? 0);
    setText('lint-coverage', typeof stats.coverage === 'number' ? `${stats.coverage}%` : '0%');
  }

  function renderIssueList(issues) {
    if (!Array.isArray(issues) || !issues.length) {
      return '<div class="lint-empty">Sin hallazgos relevantes. Puedes declarar con confianza.</div>';
    }

    const cards = issues.slice(0, 6).map(renderIssueCard).join('');
    if (issues.length > 6) {
      return `${cards}<div class="lint-placeholder">Mostrando ${Math.min(6, issues.length)} de ${issues.length} hallazgos.</div>`;
    }
    return cards;
  }

  function renderIssueCard(issue) {
    const severity = issue.severity || 'info';
    const severityLabel = formatSeverity(severity);
    const badgeClass = severity === 'critical' ? 'lint-critical' : severity === 'warning' ? 'lint-warning' : 'lint-info';
    const affected = Array.isArray(issue.affected) ? issue.affected.slice(0, 6) : [];
    const affectedMarkup = affected.length ? `
      <div class="lint-affected">
        ${affected.map((item) => `<span class="lint-chip">${escapeHtml(item)}</span>`).join('')}
      </div>
    ` : '';
    const hintMarkup = issue.hint ? `<p class="lint-hint"><i class="fas fa-lightbulb"></i> ${escapeHtml(issue.hint)}</p>` : '';
    const ruleMarkup = issue.ruleId ? `<span class="lint-rule">${escapeHtml(issue.ruleId)}</span>` : '';

    return `
      <div class="lint-issue" data-severity="${severity}">
        <div class="lint-issue-head">
          <div>
            <div class="lint-severity ${badgeClass}">${severityLabel}</div>
            <h4>${escapeHtml(issue.title || 'Hallazgo')}</h4>
          </div>
          ${ruleMarkup}
        </div>
        <p class="lint-message">${escapeHtml(issue.message || '')}</p>
        ${affectedMarkup}
        ${hintMarkup}
      </div>
    `;
  }

  function setLintLoading(isLoading) {
    const btn = document.querySelector('.btn-lint-refresh');
    if (btn) {
      btn.classList.toggle('loading', !!isLoading);
      btn.disabled = !!isLoading;
    }
  }

  function setText(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value;
    }
  }

  function escapeHtml(value) {
    return (value ?? '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function formatTimestamp(value) {
    if (!value) return 'Sin ejecutar';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return value;
    return date.toLocaleString();
  }

  function formatSeverity(severity) {
    switch (severity) {
      case 'critical':
        return 'Cr√≠tico';
      case 'warning':
        return 'Advertencia';
      default:
        return 'Nota';
    }
  }

  // ============================================
  // API P√öBLICA
  // ============================================

  window.SRIPanel = {
    render() {
      return TEMPLATE;
    },
    initialize,
    iniciarWorkflow103,
    iniciarWorkflow104,
    generarATSAutomatico,
    verHistorial,
    verHistorialATS,
    abrirDocumento,
    abrirAsistenteIA,
    abrirConfiguracion,
    ejecutarDiagnostico: () => renderDiagnostics(true)
  };
})();
